---
- name: Install nginx package
  ansible.builtin.package:
    name:
      - nginx
    state: present

- name: Install php-fpm package if required
  ansible.builtin.package:
    name:
      - php-fpm
    state: present
  when: "nginx_fastcgi_php is defined and nginx_fastcgi_php"

- name: Start nginx
  ansible.builtin.service:
    name: nginx
    state: started
    use: service

- name: Push nginx.conf template
  ansible.builtin.template:
    src: "nginx.conf.j2"
    mode: "0644"
    owner: root
    group: root
    dest: /etc/nginx/nginx.conf
    backup: true
  notify: Restart nginx

- name: Push default site configuration
  ansible.builtin.template:
    src: "default.j2"
    mode: "0644"
    owner: root
    group: root
    dest: /etc/nginx/sites-available/default
    backup: true
  notify: Restart nginx

- name: Push first site content
  ansible.builtin.copy:
    src: "{{ lookup('first_found', findme) }}"
    dest: /var/www
    mode: "0644"
  vars:
    findme:
      - "{{ inventory_hostname }}/html"
      - default/html
